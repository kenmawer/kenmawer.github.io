---
title: "Predicting COVID Case Counts in Japan"
author: "Ken Mawer"
date: "`r Sys.Date()`"
output: pdf_document
---



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(readxl)
library(ggplot2)
library(zoo)
library(lars)
library(glmnet)
```

```{r data, include=FALSE}
jp_covid <- read_csv("https://toyokeizai.net/sp/visual/tko/covid19/csv/prefectures.csv",show_col_types = FALSE)

pop_url <- "https://www.stat.go.jp/data/nenkan/66nenkan/zuhyou/y660203000.xls"
pop_destfile <- "y660203000.xls"
curl::curl_download(pop_url, pop_destfile)
jp_pop_colnames <- names(read_excel(pop_destfile,skip = 5))
jp_pop_unfiltered <- read_excel(pop_destfile, col_names = jp_pop_colnames , skip = 12)

demo_url <- "https://www.stat.go.jp/data/nenkan/66nenkan/zuhyou/y660207000.xls"
demo_destfile <- "y660207000.xls"
curl::curl_download(demo_url, demo_destfile)
jp_demo_colnames = c("pref_jp","prefecture","total","under_15","15_64","65_plus","75_plus")
jp_demo <- read_excel(demo_destfile, col_names = jp_demo_colnames, 
    skip = 12)

```


```{r cleaning, include=FALSE}
jp_filtered <- filter(jp_covid,(year == 2021 & month < 11) |
                        (year == 2020 & month > 10) |
                        (year == 2020 & month == 10 & date > 3)
  )
jp_filtered <- mutate(jp_filtered,day=as.Date(paste(year,month,date,sep="-")))
jp_filtered <- select(jp_filtered,c("day","prefectureNameE","testedPositive"))
jp_filtered <- rename(jp_filtered,cases = testedPositive,prefecture = prefectureNameE)
jp_filtered <- arrange(jp_filtered,prefecture)

```

```{r name index, include=FALSE}
jp_names <- select(jp_pop_unfiltered,c(`...3`,`...1`))
jp_names <- rename(jp_names,prefecture = `...3`,code = `...1`)
jp_names["prefecture"][jp_names["prefecture"] == "Gumma"] <- "Gunma"
```


```{r jp_rolling, include=FALSE}
jp_rolling <- mutate(jp_filtered,cases_yest = lag(jp_filtered$cases))
jp_rolling <- filter(jp_rolling,day != as.Date("2020-10-3"))
jp_rolling <- mutate(jp_rolling,new_cases = cases - cases_yest)
jp_rolling <- select(jp_rolling,c("day","prefecture","new_cases","cases"))
jp_rolling <- mutate(jp_rolling,cases_avg = c(0,0,0,0,0,0,rollmean(jp_rolling$new_cases,k=7)))
jp_rolling <- mutate(jp_rolling, one_week_ago = lag(jp_rolling$cases_avg,7),
                     two_weeks_ago = lag(jp_rolling$cases_avg,14),
                     three_weeks_ago = lag(jp_rolling$cases_avg,21))
jp_rolling <- filter(jp_rolling,day >= as.Date("2020-11-01"))

```


```{r jp_pop, include=FALSE}
jp_pop = select(jp_pop_unfiltered,c(`...3`,`2015`,`...33`))
jp_pop = rename(jp_pop,prefecture = `...3`,pop_k=`2015`,pop_density=`...33`)
jp_pop = mutate(jp_pop,population = pop_k * 1000,size = pop_k / pop_density * 1000)
jp_pop = drop_na(jp_pop)
jp_pop["prefecture"][jp_pop["prefecture"] == "Gumma"] <- "Gunma"

```

```{r jp_demo, include=FALSE}
jp_demo = drop_na(jp_demo)
jp_demo = subset(jp_demo,select = -pref_jp)
jp_demo = mutate(jp_demo,
                 percent_u15 = 100 * under_15 / total,
                 percent_15_64 = 100 * `15_64` / total,
                 percent_o65 = 100 *`65_plus` / total,
                 percent_o75 = 100 * `75_plus` / total)
jp_demo = subset(jp_demo,select = -c(under_15,`15_64`,`65_plus`,`75_plus`,total))
jp_demo["prefecture"][jp_demo["prefecture"] == "Gumma"] <- "Gunma"

```

```{r jp_data, include=FALSE}
jp_pop = jp_pop_unfiltered %>%
  select(c(`...3`,`2015`,`...33`)) %>%
  rename(prefecture = `...3`,pop_k=`2015`,pop_density=`...33`) %>%
  mutate(population = pop_k * 1000,size = pop_k / pop_density * 1000) %>%
  drop_na()

rm(jp_pop_unfiltered)

jp_pop["prefecture"][jp_pop["prefecture"] == "Gumma"] <- "Gunma"

jp <- jp_rolling %>%
  inner_join(jp_pop,by="prefecture") %>%
  inner_join(jp_demo,by="prefecture")

jp_final <- jp %>%
  filter(day == as.Date("2021-10-31")) %>%
  mutate(cases_per_thousand = cases / pop_k) %>%
  mutate(log_cases_per_k = log(cases_per_thousand),
         log_pop = log(population), log_pd = log(pop_density)) %>%
  select(c("day","prefecture","log_cases_per_k","log_pd","log_pop",
           "percent_u15","percent_15_64","percent_o65","percent_o75"))

```


## Introduction

Japan has one of the lowest COVID-19 incidence rates in the world. As of December 6, 2021, 6:00 pm PST, it has 1.4 cases per 100 for a country of 125.9 million people, compared to Canada with 4.7 per 100, USA with 15 per 100, and UK with 15.4. $^1$ However, its vaccination commencement was very late; on July 1, only 14.6% were fully vaccinated, compared to Canada with 31.9%, USA with 48.1%, and UK with 48.7%. $^2$ This project will not just find data relating data as a whole, but also with the individual prefectures, or subdivisions.

```{r intro_plot, fig.height=2.5}
ggplot(jp_total_rolling,aes(x=day,y=cases_avg)) +
  geom_line(col="blue",size=1.25) +
  labs(x = "Date",y="7-day rolling average", title = "Japan COVID cases")
```
COVID-19 case rates by date from November 1, 2020

Past around July 1, 2021, Japan entered its fifth wave of COVID $^3$, where case counts rose significantly to an all time high. Given Japan's slow vaccination rate, this will attempt find relationships relating to age demographics, as well as its relation to the fifth wave, as this may provide information relating to the effectiveness of the vaccine. With the over 65 age group beings prioritized first for COVID vaccinations in Japan $^4$, a potential measurement of vaccine effectiveness may be related by finding the percentage of people over 65 in a prefecture to the percentage of cases after the fifth wave.

## EDA

Being from Japan, I am interested in the COVID situation there. Given that their travel and quarantine restrictions are very strict, I would like to know about whether cases can further go down, which may justify removing barriers for entry. This is because I want to be able to see my family, some of whom is in Japan. Having learned about how hard it is to predict COVID cases during class, I still want to know if Japan is no exception to this difficulty.

I am analyzing the COVID-19 incidence rates in Japan in a two-part analysis. This analysis will compare the state of COVID across each prefecture, or administrative subdivision, across Japan. It will also attempt to find a way to predict future cases based on past cases.

The measurement of impact of COVID-19 in a prefecture will be measured related to COVID cases per capita. In a given prefecture, the response variable is the number COVID cases per 1000 people, which is driectly linearly related to COVID-19 cases per capita by multiplying that number by 1000. The factors include the population of the prefecture and the population density, which may be factored or interacted to improve the model's accuracy. I consider these factors potentially relevant, as I am from Tokyo, the most populated prefecture with a fairly high population density, and this prefecture has had many COVID cases. Additional factors include age demographics of each prefecture, as older populations are prioritized for the vaccine and may be more risk averse.

During class, we learned that it is hard to predict COVID case rates. However, I want to know if Japan is any exception to this, as I have not been able to find anything good in English relating to COVID-19 predictions, as almost everything printed in Japan will be in Japanese. Whether it is related to predicting cases in the future, or finding what factors were involved in the number of COVID cases per capita, it is difficult to find anything done in English.

Even if it may be difficult to predict COVID-19 cases, it may be possible to analyze the effects of the pandemic on prefectures (subdivisions of Japan) based on factors such as their population, population density and concentrations of different age groups.

This project uses three datasets. The Toyo Keizai dataset captures the COVID case rates in each prefecture in Japan. $^4$ In addition, I am using two Statistics Japan datasets: one captures the population and population densities of each prefecture in Japan, $^5$ and another captures the distribution of different age groups in Japan. $^6$

## Results

### Effect of fifth wave

July 1, 2021 is a cutoff date for determining the fifth wave, as the cases in Japan overall increased. This provides a more easily understandable cutoff date, given that this is the last four months.

This study will categorize prefectures by the extent to which COVID affected them for the fifth wave, which is after when many people were vaccinated. In addition, it attempts to predict COVID case rates, especially after using a measure that calculates the detriment of the fifth wave, measured by the proportion of cases in the fifth wave, scaled as the logarithm of the odds ratio.

The prediction accuracy of predicting the ratio of cases is poor, with an adjusted $R^2$ of only 0.217, despite the log population and the product of log population with log population density being statistically significant. Lasso regression was used to find a model that minimizes cross-validation error. The model found calculates this as follows:

$y = -0.3599x_{lp} + 0.0135 x_{lp} x_{lpd}  - 0.001 x_{lp} x_{o65} + 4.7343$

where $x_{lp}$ is the log population, $x_{lpd}$ is the log population density and $x_{o65}$ is the percentage of people over 65. $y$ is the 

```{r jp_fifth_wave, include = FALSE}
jp_before <- jp_rolling %>%
  filter(day < as.Date("2021-07-01")) %>%
  select(c("prefecture","new_cases")) %>%
  group_by(prefecture) %>%
  summarize(cases_before = sum(new_cases))
jp_after <- jp_rolling %>%
  filter(day >= as.Date("2021-07-01")) %>%
  select(c("prefecture","new_cases")) %>%
  group_by(prefecture) %>%
  summarize(cases_after = sum(new_cases))

jp_wave <- jp_before %>% inner_join(jp_after,"prefecture") %>%
  mutate(case_odds = log(cases_after / cases_before)) %>%
  inner_join(jp_final,by="prefecture")

rm(jp_before,jp_after)
```

```{r ratio_glm, message=FALSE}
set.seed(420)

lm_jp_wave <- lm(case_odds ~ log_pop * log_pd * percent_o65, jp_wave)
summary(lm_jp_wave)

f <- as.formula(case_odds ~ log_pop * log_pd * percent_o65 + 0)
x <- model.matrix(f,jp_wave)
y <- jp_wave$case_odds

lasso_jp_wave <- glmnet(x,y,lambda=0.0001)

lambdas <- exp(seq(-8, -3, length = 21))

tmp <- cv.glmnet(
  x = x, y = y, lambda = lambdas, nfolds = 4, alpha = 1,
  family = "gaussian", intercept = TRUE
)

plot(tmp, lwd = 6, cex.axis = 1.5, cex.lab = 1.2)

coef(glmnet(x,y,lambda=exp(-5.8)))

lm_jp_wave_best <- lm(case_odds ~ log_pop + log_pop:log_pd + log_pop:percent_o65,jp_wave)

summary(lm_jp_wave_best)

```

## Predicting COVID cases per capita in prefectures of Japan using population and population density

Using a regular linear model, we see that both population and population density have a linear relationship to COVID cases per capita.

```{r covid_prefs, fig.width=6,fig.height= 4, echo = FALSE, message=FALSE}
ggplot(jp_final,aes(log_pop,log_cases_per_k)) +
  geom_point() +
  geom_smooth(method = "lm") +
  labs(x="log population", y="log cases per 1000", title = "Population vs. COVID cases/1K")
```

This graph does appear to show a relationship of population and COVID cases per 1,000. However, it is heteroskedastic.

```{r covid_prefs_2, fig.width=6,fig.height= 4, echo = FALSE, message=FALSE}
ggplot(jp_final,aes(log_pd,log_cases_per_k)) +
  geom_point() +
  geom_smooth(method = "lm") +
  labs(x="log population density", y="log cases per 1000", title = "Population density vs. COVID cases/1K")
```

This graph also appears to show a relationship of population density and COVID cases per 1,000. Again, it is heteroskedastic.

To potentially increase the model's acccuracy and reduce the model's heteroskedasticity, a model with both these variables and interaction terms is used. The adjusted $R^2$ is 0.699, where both the population and population density are positively correlated with higher COVID cases, but that there is a negative interaction term when those are multiplied:

```{r covid_model_pop, fig.width=6,fig.height= 4, echo = FALSE, message=FALSE}
lm_jp_pop <- lm(log_cases_per_k ~ log_pop * log_pd, data = jp_final)
preds <- data.frame(log_cases_per_k = jp_final$log_cases_per_k, fitted = lm_jp_pop$fitted.values)

ggplot(preds,aes(log_cases_per_k,fitted)) +
  geom_point() +
  geom_smooth(method = "lm") +
  labs(x="Actual log cases per 1000", y="Modelled log cases per 1000", title = "Population vs. COVID cases/1K")
```

The graph is an improvement over the other graphs before due to homoskedasticity.

## Predicting COVID cases in prefectures by age demographics

Using a model with age demographics involving percentages of each age group (<15,15-64, 65+ and 75+) results in only the percentage of people over 75 being a statistically significant result (adjusted $R^2$ of 0.7546). Using only the amount of over 75's, we now get an adjusted $R^2$ . There is evidence to suggest that prefectures with higher percentages of over 75's have lower numbers of COVID cases per capita. This suggests that they are either likely to get themselves infected with COVID due to risk or other reasons, or because they were prioritized for the vaccine.

```{r covid_model_dem, fig.width=6,fig.height= 4, echo = FALSE, message=FALSE}
lm_jp_demo <- lm(log_cases_per_k ~ percent_o75, data = jp_final)

ggplot(lm_jp_demo,aes(percent_o75,log_cases_per_k)) +
  geom_point() +
  geom_smooth(method = "lm") +
  labs(x="Percent over 75", y="log cases per 1000", title = "Over 75's and COVID cases/1K")
```

## Cross-validated selection

To improve this model, we use cross-validation rather than select based on p-values.



## Can we get the best of both worlds?

Making a model that includes the logarithm of the population, the logarithm of the population density, the interaction term, and the percentage of people over 75 brings the adjusted $R^2$ to 0.7859. Indeed, the scatter from the prediction line appears to have somewhat mitigated.

However, the predictors relating to the population and population density now have higher p-values, where only the factor of the percentage of the population being over 75 being statistically significant.

The model is as follows, where $x_{75}$ is the variable relating to the percentage of people over 75, $x_p$ is the population, and $x_d$ is the population density in terms of people per square kilometre. $y$ refers to the COVID cases per 1000 people in a prefecture.

$\ln y=-0.39298-0.19434x_{75}+0.29737 \ln x_p+0.53754 \ln x_d - 0.02766 \ln x_p \ln x_d$

The graph below illustrates the fit of the model with respect to the response variable.

```{r covid_model_both, fig.width=6,fig.height= 4, echo = FALSE, message=FALSE}
lm_jp_both <- lm(log_cases_per_k ~ percent_o75 + log_pop * log_pd, data = jp_final)
preds_both <- data.frame(log_cases_per_k = jp_final$log_cases_per_k, fitted = lm_jp_both$fitted.values)

ggplot(preds_both,aes(fitted,log_cases_per_k)) +
  geom_point() +
  geom_smooth(method = "lm") +
  labs(x="Modelled log cases per 1000",y="Actual log cases per 1000", title = "Population vs. COVID cases/1K")
```

## Predicting COVID trends in Japan over time.

Predicting each prefecture is arguably more inconsistent when there are 47 prefectures in Japan. Moreover, many policies are dependent upon the country's situation itself. Thus, I am predicting the COVID trends in Japan overall, rather than individual prefectures.

```{r covid_over_time_tr, fig.width=6,fig.height= 4, echo = FALSE, message=FALSE, warning=FALSE}
jp_total_rolling <- jp_rolling %>%
  subset(select = -prefecture) %>%
  group_by(day) %>%
  summarize(across(everything(), sum))

jp_train <- filter(jp_total_rolling,day < as.Date("2021-10-11"))
jp_test <- filter(jp_total_rolling,day >= as.Date("2021-10-11"))
lm_jp <- lm(cases_avg ~ one_week_ago * two_weeks_ago * three_weeks_ago, data = jp_total_rolling) #overall model
lm_jp_tr <- lm(cases_avg ~ one_week_ago * two_weeks_ago * three_weeks_ago, data = jp_train)

jp_train <- mutate(jp_train, predictions = predict(lm_jp_tr))

jp_tr_stacked <- jp_train %>% 
  select(day,cases_avg,predictions) %>%
  rename(`7-day average` = cases_avg, `Predicted average` = predictions) %>%
  gather("Category","cases",`7-day average`,`Predicted average`)

ggplot(jp_tr_stacked,aes(x=day,y=cases,color=Category)) +
  geom_line(size=1) +
  labs(x="Date", y="7-day rolling average", title = "Cases rolling average")

```

This model is accurate to an adjusted $R^2$ with 0.9626. Taking out the last three weeks for this to be used for testing data, we have that the accuracy of the training model is 0.9612. The accuracy may not be the same when we test the data outsite that has been extrapolated from the time series.


```{r covid_over_time_te, fig.width=6,fig.height= 4, echo = FALSE, message=FALSE, warning=FALSE}
jp_test <- mutate(jp_test, predictions = predict(lm_jp_tr,jp_test))

jp_te_stacked <- jp_test %>% 
  select(day,cases_avg,predictions) %>%
  rename(`7-day average` = cases_avg, `Predicted average` = predictions) %>%
  gather("Category","cases",`7-day average`,`Predicted average`)

ggplot(jp_te_stacked,aes(x=day,y=cases,color=Category)) +
  geom_line(size=1) +
  labs(x="Date", y="7-day rolling average", title = "Cases rolling average with prediction outside training data")

```

However, further effort needs to be done to select a model that does not overfit. By merely using linear regression and extrapolation without cross-validation, the model accuracy seems very poor, as shown above. Even when the cases decrease, the model used does not seem to account for this, but instead produces a jagged line. This suggests that the model is overfitting the data. It may be possible to improve the model through cross-validation, as to reduce overfitting. However, it is important to remember that the model would still utilize extrapolation, which is inherently risky. We want to create a model that reduces problems relating to overfitting.

## Results



## Further research

More insight may be possible by analyzing COVID cases before the commencement of vaccination for seniors, as this may provide implications relating to the effectiveness of the COVID vaccine itself. However, this would omit the fifth wave of COVID, which happened after vaccination and resulted in a significant increase in COVID cases. The omission of this fifth wave may even be useful in describing the effectiveness of the COVID-19 vaccine through comparing demographics, which would suggest different vaccination rates. This would likely necessitate also gathering Japan's COVID-19 vaccination rate, as to ensure an accurate comparison.


## References

worldometers.info/coronavirus/ $^1$

https://ourworldindata.org/covid-vaccinations $^2$

https://www.japantimes.co.jp/news/2021/09/26/national/infection-drop-fifth-wave/ $^3$

https://www3.nhk.or.jp/nhkworld/en/news/backstories/1547/ $^4$

https://toyokeizai.net/sp/visual/tko/covid19/en.html $^5$

https://www.stat.go.jp/data/nenkan/66nenkan/zuhyou/y660203000.xls $^6$

https://www.stat.go.jp/data/nenkan/66nenkan/zuhyou/y660207000.xls $^7$

## References for using R

https://www.storybench.org/how-to-calculate-a-rolling-average-in-r/

https://stackoverflow.com/questions/16299891/estimating-many-interaction-terms-in-glmnet/16303030